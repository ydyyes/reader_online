/*定义光标*/
var cursorPosition = {
	get: function (textarea) {
		var rangeData = {text: "", start: 0, end: 0 };
		if (textarea.setSelectionRange) { // W3C	
			textarea.focus();
			rangeData.start= textarea.selectionStart;
			rangeData.end = textarea.selectionEnd;
			rangeData.text = (rangeData.start != rangeData.end) ? textarea.value.substring(rangeData.start, rangeData.end): "";
		} else if (document.selection) { // IE
			textarea.focus();
			var i,
				oS = document.selection.createRange(),
				oR = document.body.createTextRange();
			oR.moveToElementText(textarea);
			
			rangeData.text = oS.text;
			rangeData.bookmark = oS.getBookmark();
			
			for (i = 0; oR.compareEndPoints('StartToStart', oS) < 0 && oS.moveStart("character", -1) !== 0; i ++) {
				if (textarea.value.charAt(i) == '\r' ) {
					i ++;
				}
			}
			rangeData.start = i;
			rangeData.end = rangeData.text.length + rangeData.start;
		}
		
		return rangeData;
	},
	
	set: function (textarea, rangeData) {
		var oR, start, end;
		if(!rangeData) {
			alert("You must get cursor position first.")
		}
		textarea.focus();
		if (textarea.setSelectionRange) { // W3C
			textarea.setSelectionRange(rangeData.start, rangeData.end);
		} else if (textarea.createTextRange) { // IE
			oR = textarea.createTextRange();
			
			if(textarea.value.length === rangeData.start) {
				oR.collapse(false);
				oR.select();
			} else {
				oR.moveToBookmark(rangeData.bookmark);
				oR.select();
			}
		}
	},

	add: function (textarea, rangeData, text) {
		var oValue, nValue, oR, sR, nStart, nEnd, st;
		this.set(textarea, rangeData);
		
		if (textarea.setSelectionRange) { // W3C
			oValue = textarea.value;
			nValue = oValue.substring(0, rangeData.start) + text + oValue.substring(rangeData.end);
			nStart = nEnd = rangeData.start + text.length;
			st = textarea.scrollTop;
			textarea.value = nValue;
			// After textarea.values = nValue, scrollTop value to 0
			if(textarea.scrollTop != st) {
				textarea.scrollTop = st;
			}
			textarea.setSelectionRange(nStart, nEnd);
		} else if (textarea.createTextRange) { // IE
			sR = document.selection.createRange();
			sR.text = text;
			sR.setEndPoint('StartToEnd', sR);
			sR.select();
		}
	}
}

$(function(){

	var tx = document.getElementById("edit"),
		pos;

	//H1标记
	$("a[title='h1']").click(function(){
		pos = cursorPosition.get(tx);
		result = pos.text?pos.text:"标题";
		cursorPosition.add(tx, pos, "# "+result+" #"); 
	});

	//加粗
	$("a[title='bold']").click(function(){
		pos = cursorPosition.get(tx);
		result = pos.text?pos.text:"内容";
		cursorPosition.add(tx, pos, "**"+result+"**"); 
	});

	$("a[title='itl']").click(function(){
		pos = cursorPosition.get(tx);
		result = pos.text?pos.text:"内容";
		cursorPosition.add(tx, pos, "__"+result+"__"); 
	});

	$("a[title='link']").click(function(){
		$("#myLink").modal({backdrop:true});
	});

	$("a.link-sure").click(function(){
		var title = $("input[name='url-title']").val();
		var url = $("input[name='url']").val();
		if(!title && !url)
			return false;
		pos = cursorPosition.get(tx);
		if(!title)
			title = pos.text?pos.text:url;

		cursorPosition.add(tx, pos, "["+title+"]("+url+" \""+title+"\")"); 
		$("#myLink").modal("hide");
	})

	$("a[title='uploadImgs']").click(function(){
	});

	$("a[title='code']").click(function(){
		$("#myCode").modal({backdrop:true});
	});

	$("a.code-sure").click(function(){
		var language = $("select[name='code-language']").val();
		pos = cursorPosition.get(tx);
		var cods = pos.text?pos.text:"代码";
		cursorPosition.add(tx, pos, "```"+language+"\n"+cods+"\n```");
		$("#myCode").modal("hide");
	})

	//上传
	$('#file_upload').uploadify({
		'buttonText': 'Img',
		'buttonImage': 'yedit/theme/picture.png',
		'width':'16',
		'height':'16',
		'uploader' : '../../uploadify.php',
		'onUploadComplete':function(file){
			pos = cursorPosition.get(tx);
			cursorPosition.add(tx, pos, "!["+file.size+"]("+file.name+")");
		}
	});

	//无序列表
	$("a[title='unlist']").click(function(){
		pos = cursorPosition.get(tx);
		cursorPosition.add(tx, pos, "- "); 
	});
	//有序列表
	$("a[title='numberlist']").click(function(){
		pos = cursorPosition.get(tx);
		cursorPosition.add(tx, pos, "1. "); 
	});
})
